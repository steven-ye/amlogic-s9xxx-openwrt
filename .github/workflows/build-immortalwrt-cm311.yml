name: Build ImmortalWrt 24.10.5 for CM311-1a (S905L3A)

# 触发方式：手动触发 + 推送配置文件触发
on:
  workflow_dispatch:
  push:
    paths:
      - 'config-files/immortalwrt/armvirt/64/*'
      - '.github/workflows/build-immortalwrt.yml'

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      # 步骤1：拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@main

      # 步骤2：安装编译依赖（适配 24.10.5）
      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update -y
          sudo apt full-upgrade -y
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
                              gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip \
                              zlib1g-dev file wget curl qemu-utils python3-pip
          pip3 install requests

      # 步骤3：拉取 ImmortalWrt 24.10.5 源码（核心修改）
      - name: Clone ImmortalWrt 24.10.5 source
        run: |
          # 拉取 24.10 稳定分支（对应 24.10.5 版本）
          git clone -b openwrt-24.10 --single-branch https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt
          # 切换到 24.10.5 标签（精准匹配版本）
          git checkout v24.10.5
          # 更新并安装 feeds（适配 24.10.5）
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 步骤4：导入 CM311-1a 配置文件
      - name: Import CM311-1a config
        run: |
          cp config-files/immortalwrt/armvirt/64/immortalwrt-armvirt-64-default.config immortalwrt/.config
          cd immortalwrt
          make defconfig

      # 步骤5：下载 24.10.5 依赖包（避免网络问题）
      - name: Download dependencies
        run: |
          cd immortalwrt
          make -j$(nproc) download V=s

      # 步骤6：编译 24.10.5 固件（失败时单线程重试）
      - name: Build ImmortalWrt 24.10.5 firmware
        run: |
          cd immortalwrt
          make -j$(nproc) V=s || make -j1 V=s

      # 步骤7：打包 CM311-1a 专用镜像（集成 DTB）
      - name: Package for CM311-1a
        run: |
          # 下载 CM311-1a 专用 DTB
          wget -O immortalwrt/bin/targets/armvirt/64/meson-gxl-s905l3a-cm311-1a.dtb https://raw.githubusercontent.com/ophub/amlogic-s9xxx-openwrt/main/dtb/amlogic/meson-gxl-s905l3a-cm311-1a.dtb
          # 解压并命名（标注 24.10.5 版本）
          cd immortalwrt/bin/targets/armvirt/64
          gzip -d immortalwrt-*-armvirt-64-generic-ext4-combined.img.gz
          mv immortalwrt-*-armvirt-64-generic-ext4-combined.img immortalwrt-24.10.5-cm311-1a-s905l3a.img

      # 步骤8：上传到 Releases（标注版本）
      - name: Upload to Releases
        uses: softprops/action-gh-release@master
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: immortalwrt/bin/targets/armvirt/64/immortalwrt-24.10.5-cm311-1a-s905l3a.img
          tag_name: ImmortalWrt-24.10.5-CM311-1a-$(date +%Y%m%d)
          body: "适配 CM311-1a (S905L3A) 的 ImmortalWrt 24.10.5 固件，内置 RTL8822CS 无线驱动，可直接线刷"